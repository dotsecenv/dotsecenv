name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: 'go.sum'

      - name: Install Signing Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm

      - name: Setup GPG key
        id: setup_gpg
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          GPG_KEY_FILE="${{ runner.temp }}/gpg.key"
          echo "$GPG_PRIVATE_KEY" > "$GPG_KEY_FILE"
          chmod 600 "$GPG_KEY_FILE"
          echo "GPG_KEY_FILE=$GPG_KEY_FILE" >> $GITHUB_ENV

      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          trust_level: 5

      - name: Generate App Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            homebrew-tap
            packages

      - name: Install Syft
        uses: anchore/sbom-action@v0

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ORG_TOKEN: ${{ steps.app-token.outputs.token }}
          GPG_KEY_FILE: ${{ env.GPG_KEY_FILE }}
          GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }}
          NFPM_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Attest Build Provenance
        if: ${{ !github.event.repository.private }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: "dist/*"

  notarize-macos:
    needs: goreleaser
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          trust_level: 5

      - name: Download release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.ref_name }}"
          ARCHIVE="dotsecenv_${VERSION#v}_Darwin_${{ matrix.arch }}.tar.gz"

          # Download archive and extract to separate directory
          gh release download "$VERSION" --pattern "$ARCHIVE" --dir .
          mkdir -p archive-contents
          tar -xzf "$ARCHIVE" -C archive-contents

      - name: Sign and notarize
        env:
          APPLE_CERTIFICATE_P12_BASE64: ${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_API_KEY_P8_BASE64: ${{ secrets.APPLE_API_KEY_P8_BASE64 }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: bash scripts/notarize-macos.sh ./archive-contents/dotsecenv

      - name: Re-package and re-sign archive
        run: |
          VERSION="${{ github.ref_name }}"
          ARCHIVE="dotsecenv_${VERSION#v}_Darwin_${{ matrix.arch }}.tar.gz"

          # Re-create archive from extracted directory (preserves original structure)
          tar -czf "$ARCHIVE" -C archive-contents .

          # Re-sign the archive with GPG (binary .sig format to match GoReleaser)
          rm -f "${ARCHIVE}.sig"
          gpg --batch --yes --detach-sign \
            --default-key "${{ steps.import_gpg.outputs.keyid }}" \
            "$ARCHIVE"

      - name: Upload updated assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.ref_name }}"
          ARCHIVE="dotsecenv_${VERSION#v}_Darwin_${{ matrix.arch }}.tar.gz"

          # Delete old assets and upload new ones
          gh release delete-asset "$VERSION" "$ARCHIVE" --yes || true
          gh release delete-asset "$VERSION" "${ARCHIVE}.sig" --yes || true

          gh release upload "$VERSION" "$ARCHIVE" --clobber
          gh release upload "$VERSION" "${ARCHIVE}.sig" --clobber

      - name: Cleanup secrets
        if: always()
        run: |
          # Clean up any Apple signing secrets that may remain
          rm -f "${{ runner.temp }}/certificate.p12" 2>/dev/null || true
          rm -f "${{ runner.temp }}/notarize.zip" 2>/dev/null || true
          rm -rf "$HOME/.private_keys" 2>/dev/null || true

          # Delete signing keychain if it exists
          if security list-keychains | grep -q "signing.keychain-db"; then
            security delete-keychain "${{ runner.temp }}/signing.keychain-db" 2>/dev/null || true
          fi

  update-checksums:
    needs: notarize-macos
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          trust_level: 5

      - name: Download and regenerate checksums
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.ref_name }}"

          # Download current checksums, darwin archives, and their signatures
          gh release download "$VERSION" --pattern "checksums.txt" --dir .
          gh release download "$VERSION" --pattern "dotsecenv_*_Darwin_*.tar.gz" --dir .
          gh release download "$VERSION" --pattern "dotsecenv_*_Darwin_*.tar.gz.sig" --dir .

          # Regenerate checksums for darwin archives and signatures
          for file in dotsecenv_*_Darwin_*.tar.gz dotsecenv_*_Darwin_*.tar.gz.sig; do
            # Remove old line, add new checksum
            grep -v "$file" checksums.txt > checksums.txt.tmp || true
            sha256sum "$file" >> checksums.txt.tmp
            mv checksums.txt.tmp checksums.txt
          done

          # Sort checksums file for consistency
          sort checksums.txt -o checksums.txt

      - name: Re-sign and upload checksums
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.ref_name }}"

          # Re-sign checksums (binary .sig format to match GoReleaser)
          rm -f checksums.txt.sig
          gpg --batch --yes --detach-sign \
            --default-key "${{ steps.import_gpg.outputs.keyid }}" \
            checksums.txt

          # Upload updated checksums
          gh release delete-asset "$VERSION" "checksums.txt" --yes || true
          gh release delete-asset "$VERSION" "checksums.txt.sig" --yes || true
          gh release upload "$VERSION" checksums.txt --clobber
          gh release upload "$VERSION" checksums.txt.sig --clobber

      - name: Attest Darwin Archives
        if: ${{ !github.event.repository.private }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: "dotsecenv_*_Darwin_*.tar.gz"

  trigger-repo-update:
    needs: [goreleaser, update-checksums]
    runs-on: ubuntu-latest
    steps:
      - name: Generate App Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            packages
            website

      - name: Trigger packages update
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: dotsecenv/packages
          event-type: update-packages
          client-payload: '{"version": "${{ github.ref_name }}"}'

      - name: Trigger action E2E tests
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ github.token }}
          repository: dotsecenv/dotsecenv
          event-type: trigger-action-e2e
          client-payload: '{"version": "${{ github.ref_name }}"}'

      - name: Trigger website redeploy
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: dotsecenv/website
          event-type: publish-site
          client-payload: '{"version": "${{ github.ref_name }}"}'
