name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: 'go.sum'

      - name: Install Signing Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm

      - name: Install Zig (for CGO cross-compilation)
        uses: mlugg/setup-zig@v2
        with:
          version: 0.13.0

      - name: Setup GPG key
        id: setup_gpg
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          GPG_KEY_FILE="${{ runner.temp }}/gpg.key"
          echo "$GPG_PRIVATE_KEY" > "$GPG_KEY_FILE"
          chmod 600 "$GPG_KEY_FILE"
          echo "GPG_KEY_FILE=$GPG_KEY_FILE" >> $GITHUB_ENV

      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          trust_level: 5

      - name: Generate App Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            homebrew-tap
            packages

      - name: Install Syft
        uses: anchore/sbom-action@v0

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ORG_TOKEN: ${{ steps.app-token.outputs.token }}
          GPG_KEY_FILE: ${{ env.GPG_KEY_FILE }}
          GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }}
          NFPM_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Attest Build Provenance
        if: ${{ !github.event.repository.private }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: "dist/*"

  trigger-repo-update:
    needs: goreleaser
    runs-on: ubuntu-latest
    steps:
      - name: Generate App Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            packages

      - name: Trigger packages update
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: dotsecenv/packages
          event-type: update-packages
          client-payload: '{"version": "${{ github.ref_name }}"}'

      - name: Trigger action E2E tests
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ github.token }}
          repository: dotsecenv/dotsecenv
          event-type: trigger-action-e2e
          client-payload: '{"version": "${{ github.ref_name }}"}'
